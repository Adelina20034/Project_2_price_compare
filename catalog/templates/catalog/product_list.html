{% extends 'catalog/base.html' %}

{% block title %}–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω{% endblock %}

{% block content %}


<h1>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h1>
<p style="color: #666; font-size: 16px; margin-bottom: 30px;">–ü—è—Ç—ë—Ä–æ—á–∫–∞ vs –ú–∞–≥–Ω–∏—Ç</p> <!-- –§–û–†–ú–ê –ü–û–ò–°–ö–ê -->

<form method="get" class="search-container">
    <input type="text" name="q" class="search-input"
        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–º–æ–ª–æ–∫–æ, —Ö–ª–µ–±, –±–∞—Ç–æ–Ω –∏ —Ç.–¥.)..." value="{{ query }}"
        autocomplete="off">
    <button type="submit" class="search-btn">üîç –ù–∞–π—Ç–∏ —Ü–µ–Ω—ã</button>
</form>

<!-- –û–®–ò–ë–ö–ê (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if error_message %}
<div class="error-message">
    ‚ùå {{ error_message }}
</div>
{% endif %}

<!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
{% if pairs or pyat_only or magnit_only %}
<div class="stats">
    <div class="stat-box">
        <h3 class="stat-title">–ü–∞—Ä –Ω–∞–π–¥–µ–Ω–æ</h3>
        <div class="stat-value">{{ pairs_count }}</div>
    </div>
    <div class="stat-box">
        <h3 class="stat-title">–¢–æ–ª—å–∫–æ –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ</h3>
        <div class="stat-value">{{ pyat_single_count }}</div>
    </div>
    <div class="stat-box">
        <h3 class="stat-title">–¢–æ–ª—å–∫–æ –≤ –ú–∞–≥–Ω–∏—Ç–µ</h3>
        <div class="stat-value">{{ magnit_single_count }}</div>
    </div>
    <div class="stat-box">
        <h3 class="stat-title">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</h3>
        <div class="stat-value">{{ total_products }}</div>
    </div>
</div>

<!-- –ü–ê–†–´ –¢–û–í–ê–†–û–í -->
{% if pairs %}
<div class="pairs-section">
    <h2 class="section-title">‚úÖ –¢–æ–≤–∞—Ä—ã —Å –ø–∞—Ä–æ–π</h2>
    <div class="pairs-grid">
        {% for pair in pairs %}
        <div class="pair-card">
            <div class="pair-header">
                <span>–°—Ö–æ–¥—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤</span> <span class="pair-similarity">{{ pair.similarity }}%</span>
            </div>
            <div class="pair-content">
                <!-- –ü–Ø–¢–Å–†–û–ß–ö–ê -->
                <div class="store-item pyat {% if pair.cheaper_store_name == '–ü—è—Ç—ë—Ä–æ—á–∫–∞' %}cheaper{% endif %}">
                    {% if pair.cheaper == '–ü—è—Ç—ë—Ä–æ—á–∫–∞' %}
                    <div class="cheaper-label">‚ú® –î–µ—à–µ–≤–ª–µ</div>
                    {% endif %}
                    <div class="store-label">üîµ –ü—è—Ç—ë—Ä–æ—á–∫–∞</div>
                    <div class="store-name">
                        {{ pair.name_pyat }}
                    </div>
                    <div class="store-price pyat">{{ pair.price_pyat|floatformat:2 }}‚ÇΩ</div>
                </div>

                <!-- –ú–ê–ì–ù–ò–¢ -->
                <div class="store-item magnit {% if pair.cheaper_store_name == '–ú–∞–≥–Ω–∏—Ç' %}cheaper{% endif %}">
                    {% if pair.cheaper == '–ú–∞–≥–Ω–∏—Ç' %}
                    <div class="cheaper-label">‚ú® –î–µ—à–µ–≤–ª–µ</div>
                    {% endif %}
                    <div class="store-label">üü† –ú–∞–≥–Ω–∏—Ç</div>
                    <div class="store-name">
                        {{ pair.name_mag }}
                    </div>
                    <div class="store-price magnit">{{ pair.price_mag|floatformat:2 }}‚ÇΩ</div>
                </div>
            </div>

            <div class="pair-footer">
                <div>
                    <div class="price-diff">–†–∞–∑–Ω–∏—Ü–∞: {{ pair.price_difference|floatformat:2 }}‚ÇΩ</div>
                </div>
                <div class="cheaper-badge">{{ pair.cheaper_store_name }}</div>
                {% if user.is_authenticated %}
                <button type="button" class="btn-cart {% if pair.id in user_cart_ids %}in-cart{% endif %}"
                    onclick="addToCart({{ pair.id }}, this)">
                    {% if pair.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- –û–î–ò–ù–û–ß–ù–´–ï –¢–û–í–ê–†–´ -->
{% if pyat_only or magnit_only %}
<div class="pairs-section">
    <h2 class="section-title">üìå –¢–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ</h2>
    <div class="single-grid">
        <!-- –ü–Ø–¢–Å–†–û–ß–ö–ê –û–î–ò–ù–û–ß–ù–´–ï -->
        {% for product in pyat_only %}
        <div class="single-card">
            <div class="store-label">üîµ –¢–æ–ª—å–∫–æ –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ</div>
            <div class="store-name"> {{ product.name_pyat }} </div>
            <div
                style=" border-top: 1px solid #e0e0e0; padding-top: 10px; font-size: 20px; font-weight: bold; color: #2196F3; margin-top: 15px; ">
                {{ product.price_pyat|floatformat:2 }}‚ÇΩ</div>
            {% if user.is_authenticated %}
            <button type="button" class="btn-cart {% if product.id in user_cart_ids %}in-cart{% endif %}"
                onclick="addToCart({{ product.id }}, this)">
                {% if product.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
            </button>
            {% endif %}
        </div>
        {% endfor %}

        <!-- –ú–ê–ì–ù–ò–¢ –û–î–ò–ù–û–ß–ù–´–ï -->
        {% for product in magnit_only %}
        <div class="single-card">
            <div class="store-label">üü† –¢–æ–ª—å–∫–æ –≤ –ú–∞–≥–Ω–∏—Ç–µ</div>
            <div class="store-name">
                {{ product.name_mag }}
            </div>
            <div style="
            border-top: 1px solid #e0e0e0;
            padding-top: 10px;
            font-size: 20px;
            font-weight: bold;
            color: #FF9800;
            margin-top: 15px;
        ">{{ product.price_mag|floatformat:2 }}‚ÇΩ</div>
            {% if user.is_authenticated %}
            <button type="button" class="btn-cart {% if product.id in user_cart_ids %}in-cart{% endif %}"
                onclick="addToCart({{ product.id }}, this)">
                {% if product.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
            </button>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% else %}
<!-- –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï -->
<div class="empty-state">
    <p style="font-size: 18px; margin-bottom: 10px;">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω</p>
    <p style="font-size: 14px;">–ü—Ä–∏–º–µ—Ä—ã: –º–æ–ª–æ–∫–æ, –±–∞—Ç–æ–Ω, —Å–æ—Å–∏—Å–∫–∏, —Ç–≤–æ—Ä–æ–≥, —Å–º–µ—Ç–∞–Ω–∞</p>
</div>
{% endif %}

<script>
    function addToCart(productId, button) {
        {% if user.is_authenticated %}
        if (!productId) {
            alert('–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
        fetch('{% url "add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `product_id=${productId}&quantity=1`
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // –ú–µ–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
                    button.classList.add('in-cart');
                    button.textContent = '‚úì –í –∫–æ—Ä–∑–∏–Ω–µ';

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showToast(data.message);

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
                    updateCartCount();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            });
        {% else %}
        window.location.href = '{% url "login" %}';
        {% endif %}
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    function updateCartCount() {
        fetch('{% url "get_cart_count" %}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('cartBadge');
                if (badge) {
                    badge.textContent = data.cart_count;
                    badge.style.display = data.cart_count > 0 ? 'flex' : 'none';
                }
            });
    }
</script>

{% endblock %}