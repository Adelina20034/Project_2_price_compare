{% extends 'catalog/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/product-list.css' %}">
{% endblock %}

{% block title %}–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω{% endblock %}

{% block content %}


<h1 class="pl-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ü–µ–Ω</h1>
<p class="pl-subtitle">–ü—è—Ç—ë—Ä–æ—á–∫–∞ vs –ú–∞–≥–Ω–∏—Ç</p>

<form method="get" class="pl-search">
    <input type="text" name="q" class="pl-search__input"
        placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–º–æ–ª–æ–∫–æ, —Ö–ª–µ–±, –±–∞—Ç–æ–Ω –∏ —Ç.–¥.)..." value="{{ query }}">
    <button type="submit" class="pl-search__button">üîç –ù–∞–π—Ç–∏ —Ü–µ–Ω—ã</button>
</form>

<!-- –û–®–ò–ë–ö–ê (–µ—Å–ª–∏ –µ—Å—Ç—å) -->
{% if error_message %}
<div class="pl-error">‚ùå {{ error_message }}</div>
{% endif %}

<!-- –ò–ù–î–ò–ö–ê–¢–û–† –ü–ê–†–°–ò–ù–ì–ê -->
<div id="loading-indicator" class="loading-indicator" data-is-searching="{{ is_searching|lower }}">
    <div class="spinner"></div>
    <span class="loading-text">
        üîç –ò—â–µ–º —Ç–æ–≤–∞—Ä—ã –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –∫–∞–∫–æ–µ-—Ç–æ –≤—Ä–µ–º—è.
    </span>
</div>

<div id="products-content">
    {% if pairs or pyat_only or magnit_only %}
    <!-- –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
    <div class="pl-stats">
        <div class="pl-stats__item">
            <h3 class="pl-stats__title">–ü–∞—Ä –Ω–∞–π–¥–µ–Ω–æ</h3>
            <div class="pl-stats__value">{{ pairs_count }}</div>
        </div>
        <div class="pl-stats__item">
            <h3 class="pl-stats__title">–¢–æ–ª—å–∫–æ –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ</h3>
            <div class="pl-stats__value">{{ pyat_single_count }}</div>
        </div>
        <div class="pl-stats__item">
            <h3 class="pl-stats__title">–¢–æ–ª—å–∫–æ –≤ –ú–∞–≥–Ω–∏—Ç–µ</h3>
            <div class="pl-stats__value">{{ magnit_single_count }}</div>
        </div>
        <div class="pl-stats__item">
            <h3 class="pl-stats__title">–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <div class="pl-stats__value">{{ total_products }}</div>
        </div>
    </div>

    <!-- –ü–ê–†–´ –¢–û–í–ê–†–û–í -->
    {% if pairs %}
    <div class="pl-section">
        <h2 class="pl-section__title">‚úÖ –¢–æ–≤–∞—Ä—ã —Å –ø–∞—Ä–æ–π</h2>
        <div class="pl-pairs">
            {% for pair in pairs %}
            <div class="pl-pair">
                <div class="pl-pair__header">
                    <span>–°—Ö–æ–¥—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤</span>
                    <span class="pl-pair__similarity">{{ pair.similarity }}%</span>
                </div>

                <div class="pl-pair__content">
                    <!-- –ü–Ø–¢–Å–†–û–ß–ö–ê -->
                    <div
                        class="pl-store pl-store--pyat {% if pair.cheaper_store_name == '–ü—è—Ç—ë—Ä–æ—á–∫–∞' %}is-cheaper{% endif %}">
                        <div class="pl-store__label">üîµ –ü—è—Ç—ë—Ä–æ—á–∫–∞</div>
                        <div class="pl-store__name">{{ pair.name_pyat }}</div>
                        <div class="pl-store__price pl-store__price--pyat">{{ pair.price_pyat|floatformat:2 }}‚ÇΩ</div>
                    </div>

                    <!-- –ú–ê–ì–ù–ò–¢ -->
                    <div
                        class="pl-store pl-store--magnit {% if pair.cheaper_store_name == '–ú–∞–≥–Ω–∏—Ç' %}is-cheaper{% endif %}">
                        <div class="pl-store__label">üü† –ú–∞–≥–Ω–∏—Ç</div>
                        <div class="pl-store__name">{{ pair.name_mag }}</div>
                        <div class="pl-store__price pl-store__price--magnit">{{ pair.price_mag|floatformat:2 }}‚ÇΩ</div>
                    </div>
                </div>

                <div class="pl-pair__footer">
                    <div class="pl-pair__diff">
                        –†–∞–∑–Ω–∏—Ü–∞: {{ pair.price_difference|floatformat:2 }}‚ÇΩ
                    </div>

                    <div class="cheaper-badge">{{ pair.cheaper_store_name }}</div>

                    {% if user.is_authenticated %}
                    <button class="pl-cart-btn {% if pair.id in user_cart_ids %}is-in-cart{% endif %}"
                        onclick="addToCart({{ pair.id }}, this)">
                        {% if pair.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- –û–î–ò–ù–û–ß–ù–´–ï –¢–û–í–ê–†–´ -->
    {% if pyat_only or magnit_only %}
    <div class="pl-section">
        <h2 class="pl-section__title">üìå –¢–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –º–∞–≥–∞–∑–∏–Ω–µ</h2>

        <div class="pl-single">
            <!-- –ü–Ø–¢–Å–†–û–ß–ö–ê –û–î–ò–ù–û–ß–ù–´–ï -->
            {% for product in pyat_only %}
            <div class="pl-single__item">
                <div class="pl-single-main-content">
                    <div class="pl-store__label">üîµ –¢–æ–ª—å–∫–æ –≤ –ü—è—Ç—ë—Ä–æ—á–∫–µ</div>
                    <div class="pl-store__name"> {{ product.name_pyat }} </div>
                </div>
                {% if user.is_authenticated %}
                <div class="pl-single-footer">
                    <div class="pl-store__price pl-store__price--pyat">
                        {{ product.price_pyat|floatformat:2 }}‚ÇΩ
                    </div>
                    <button class="pl-cart-btn {% if product.id in user_cart_ids %}is-in-cart{% endif %}"
                        onclick="addToCart({{ product.id }}, this)">
                        {% if product.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
                    </button>
                </div>
                {% else %}
                <div class="pl-store__price pl-store__price--pyat">
                    {{ product.price_pyat|floatformat:2 }}‚ÇΩ
                </div>

                {% endif %}
            </div>
            {% endfor %}

            <!-- –ú–ê–ì–ù–ò–¢ –û–î–ò–ù–û–ß–ù–´–ï -->
            {% for product in magnit_only %}
            <div class="pl-single__item">
                <div class="pl-single-main-content">
                    <div class="pl-store__label">üü† –¢–æ–ª—å–∫–æ –≤ –ú–∞–≥–Ω–∏—Ç–µ</div>
                    <div class="pl-store__name">{{ product.name_mag }}</div>
                </div>

                {% if user.is_authenticated %}
                <div class="pl-single-footer">
                    <div class="pl-store__price pl-store__price--magnit">
                        {{ product.price_mag|floatformat:2 }}‚ÇΩ
                    </div>
                    <button class="pl-cart-btn {% if product.id in user_cart_ids %}is-in-cart{% endif %}"
                        onclick="addToCart({{ product.id }}, this)">
                        {% if product.id in user_cart_ids %}‚úì –í –∫–æ—Ä–∑–∏–Ω–µ{% else %}‚ûï –í –∫–æ—Ä–∑–∏–Ω—É{% endif %}
                    </button>
                </div>
                {% else %}
                <div class="pl-store__price pl-store__price--magnit">
                    {{ product.price_mag|floatformat:2 }}‚ÇΩ
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï -->
    <div class="pl-empty">
        <p class="pl-empty__title">–í–≤–µ–¥–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ü–µ–Ω</p>
        <p class="pl-empty__text">–ü—Ä–∏–º–µ—Ä—ã: –º–æ–ª–æ–∫–æ, –±–∞—Ç–æ–Ω, —Å–æ—Å–∏—Å–∫–∏, —Ç–≤–æ—Ä–æ–≥, —Å–º–µ—Ç–∞–Ω–∞</p>
    </div>
    {% endif %}

</div>





<script>
    const urlParams = new URLSearchParams(window.location.search);
    const query = urlParams.get('q');

    // –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const loadingIndicator = document.getElementById('loading-indicator');

    // –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ (–≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö)
    const CHECK_INTERVAL = 5000; // 5 —Å–µ–∫—É–Ω–¥
    let checkInterval = null;

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏–∑ –ë–î —á–µ—Ä–µ–∑ AJAX
     */
    async function checkParsingStatus() {
        try {
            const response = await fetch(
                `{% url 'check_status' %}?q=${encodeURIComponent(query)}`
            );
            const data = await response.json();

            console.log('üìä –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞:', data);

            // –ï—Å–ª–∏ –ø–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω (is_parsing = false) - –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            if (!data.is_parsing) {
                console.log('‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...');
                clearInterval(checkInterval);
                stopLoading();

                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞:', error);
        }
    }

    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
     */
    function startLoading() {
        loadingIndicator.classList.add('active');
        console.log('üîÑ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä...');

        // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ N —Å–µ–∫—É–Ω–¥
        checkInterval = setInterval(checkParsingStatus, CHECK_INTERVAL);

        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkParsingStatus();
    }

    /**
     * –°–∫—Ä—ã–≤–∞–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
     */
    function stopLoading() {
        loadingIndicator.classList.remove('active');
        console.log('‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫—Ä—ã—Ç');
    }

    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–µ–Ω –ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    document.addEventListener('DOMContentLoaded', function () {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ–ª–∞–≥ is_searching –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        const isSearching = loadingIndicator.dataset.isSearching === 'true';

        if (isSearching && query) {
            console.log('üéØ –ü–∞—Ä—Å–∏–Ω–≥ –∞–∫—Ç–∏–≤–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä...');
            startLoading();
        } else {
            console.log('‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ –Ω—É–∂–µ–Ω');
        }
    });

    function addToCart(productId, button) {
        {% if user.is_authenticated %}
        if (!productId) {
            alert('–û—à–∏–±–∫–∞: —Ç–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
            return;
        }

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É
        fetch('{% url "add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: `product_id=${productId}&quantity=1`
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // –ú–µ–Ω—è–µ–º –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
                    button.classList.add('is-in-cart');
                    button.textContent = '‚úì –í –∫–æ—Ä–∑–∏–Ω–µ';

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showToast(data.message);

                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É');
            });
        {% else %}
        window.location.href = '{% url "login" %}';
        {% endif %}
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
</script>

{% endblock %}