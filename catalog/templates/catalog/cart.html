{% extends 'catalog/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'css/pages/cart.css' %}">
{% endblock %}

{% block title %}–ö–æ—Ä–∑–∏–Ω–∞{% endblock %}

{% block content %}

<div class="cart-header">
    <h1 class="cart-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</h1>
    {% if not is_empty %}
    <button class="cart-clear-btn" onclick="clearCart()">
        –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
    </button>
    {% endif %}
</div>

{% if is_empty %}
<div class="cart-empty">
    <div class="card__body">
        <p class="cart-empty__title">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ üò¢</p>
        <p class="cart-empty__link"><a href="/">–ù–∞—á–∞—Ç—å –ø–æ–∫—É–ø–∫–∏</a></p>
    </div>
</div>
{% else %}
<!-- üìä –¢–ê–ë–õ–ò–¶–ê –¢–û–í–ê–†–û–í -->
<div class="cart-table-wrapper">
    <table class="cart-table">
        <thead>
            <tr class="cart-row">
                <th class="cart-col cart-col--pyat">üè™ –ü—è—Ç—ë—Ä–æ—á–∫–∞</th>
                <th class="cart-col cart-col--magnit">üè™ –ú–∞–≥–Ω–∏—Ç</th>
                <th class="cart-col cart-col--qty">–ö–æ–ª-–≤–æ</th>
                <th class="cart-col cart-col--actions">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart_items %}
            <tr class="cart-row">
                <!-- –ü–Ø–¢–Å–†–û–ß–ö–ê -->
                <td class="cart-col cart-col--pyat">
                    {% if item.product.name_pyat %}
                    <div class="store-cell">
                        <div class="store-label">{{ item.product.name_pyat }}</div>
                        {% if item.product.price_pyat %}
                        <div class="price-row">
                            <span class="price">{{ item.product.price_pyat|floatformat:2 }}‚ÇΩ</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="empty-cell">
                        <span class="empty-label">–ù–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ</span>
                    </div>
                    {% endif %}
                </td>

                <!-- –ú–ê–ì–ù–ò–¢ -->
                <td class="cart-col cart-col--magnit">
                    {% if item.product.name_mag %}
                    <div class="store-cell">
                        <div class="store-label">{{ item.product.name_mag }}</div>
                        {% if item.product.price_mag %}
                        <div class="price-row">
                            <span class="price">{{ item.product.price_mag|floatformat:2 }}‚ÇΩ</span>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="empty-cell">
                        <span class="empty-label">–ù–µ—Ç –≤ –º–∞–≥–∞–∑–∏–Ω–µ</span>
                    </div>
                    {% endif %}
                </td>

                <!-- –ö–û–õ–ò–ß–ï–°–¢–í–û -->
                <td class="cart-col cart-col--qty">
                    <div class="qty-control">
                        <input type="number" min="1" max="100" value="{{ item.quantity }}" data-item-id="{{ item.id }}"
                            class="cart-qty-input" onchange="updateQuantity({{ item.id }}, this.value)" />
                    </div>
                </td>

                <!-- –î–ï–ô–°–¢–í–ò–Ø -->
                <td class="cart-col cart-col--actions">
                    <button class="cart-remove-btn" onclick="removeFromCart({{ item.id }})" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã">
                        ‚úï –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- üí∞ –ò–¢–û–ì–û–í–ê–Ø –°–£–ú–ú–ê -->
<div class="summary-section">
    <div class="summary-card">
        <h3>–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</h3>

        <div class="summary-row">
            <span class="summary-label">üè™ –ü—è—Ç—ë—Ä–æ—á–∫–∞:</span>
            <span class="summary-value">{{ pyat_total }}‚ÇΩ</span>
        </div>

        <div class="summary-row">
            <span class="summary-label">üè™ –ú–∞–≥–Ω–∏—Ç:</span>
            <span class="summary-value">{{ mag_total }}‚ÇΩ</span>
        </div>

        <div class="summary-row">
            <span class="summary-label">üè™ –¢–æ–ª—å–∫–æ –ü—è—Ç—ë—Ä–æ—á–∫–∞:</span>
            <span class="summary-value">{{ only_pyat }}‚ÇΩ</span>
        </div>

        <div class="summary-row">
            <span class="summary-label">üè™ –¢–æ–ª—å–∫–æ –ú–∞–≥–Ω–∏—Ç:</span>
            <span class="summary-value">{{ only_mag }}‚ÇΩ</span>
        </div>

        {% if cheaper_store %}
        <div class="summary-row highlight">
            <span class="summary-label">üí∞ –î–µ—à–µ–≤–ª–µ:</span>
            <span class="summary-value">{{ cheaper_store }}</span>
        </div>
        {% endif %}

        {% if total_savings != "0.00" %}
        <div class="summary-row savings">
            <span class="summary-label">üíö –≠–∫–æ–Ω–æ–º–∏—è:</span>
            <span class="summary-value highlight-green">{{ total_savings }}‚ÇΩ</span>
        </div>
        {% endif %}

    </div>
</div>
{% endif %}



<script>
    // –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞
    function updateQuantity(itemId, newQuantity) {
        const quantity = parseInt(newQuantity);

        if (quantity < 1 || quantity > 100) {
            alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100');
            location.reload();
            return;
        }

        const formData = new FormData();
        formData.append('quantity', quantity);

        fetch(`/cart/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã
    function removeFromCart(itemId) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
            fetch(`/cart/remove/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
    function clearCart() {
        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã!')) {
            fetch('/cart/clear/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    }

    // –ü–æ–ª—É—á–∏—Ç—å CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}